---
title: "Assignment Group 2 MVA"
format: html
editor: visual
---

# Load R packages
```{r}
library(tidyverse)
library(haven)
library(here)
library(gtsummary) 
library(corrplot)
library(knitr) 
library(broom)
library(tidyr)
```

# Read data
```{r}
ourdata1 <- read_csv(here('raw_data', 'insurance.csv'))
```

# Describe data
```{r}
summary(ourdata1)
```

# Another way to look at data
```{r}
str(ourdata1)
```

# Add numbering to first column because original datset has none of it
```{r}
ourdata1$ID <- seq_len(nrow(ourdata1))
ourdata1 <- ourdata1[, c("ID", names(ourdata1)[-which(names(ourdata1) == "ID")])]
```

# re look at our data
```{r}
summary(ourdata1)
```

# Convert labelled variables to factor variables
```{r}
ourdata1$sex <- as.factor(ourdata1$sex)
ourdata1$region <- as.factor(ourdata1$region)
ourdata1$smoker <- as.factor(ourdata1$smoker)
summary(ourdata1)
```

# use gtsummary to get desired descriptive analysis
```{r}
ourdata1 %>%
  select(-ID) %>%
  tbl_summary(
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  )
```

# Explore and wrangle data - perform plots
```{r}
ggplot(ourdata1, aes(charges)) + 
  geom_histogram()
```


```{r}
ggplot(ourdata1, aes(age)) + 
  geom_histogram()
```


```{r}
ggplot(ourdata1, aes(bmi)) + 
  geom_histogram()
```


```{r}
ggplot(ourdata1, aes(children)) + 
  geom_histogram()
```


```{r}
ggplot(ourdata1, aes(x = sex)) + 
  geom_bar()

```


```{r}
ggplot(ourdata1, aes(x = smoker)) + 
  geom_bar()

```


```{r}
ggplot(ourdata1, aes(x = region)) + 
  geom_bar()

```

# chechk correlation between numerical variables
```{r}
ourdata3 <- 
  ourdata1 %>% 
  select(where(is.numeric))
```


```{r}
cor.ourdata1 <-
  cor(ourdata3, 
      use = "complete.obs", 
      method = "pearson")
head(round(cor.ourdata1, 2))
```


```{r}
corrplot(cor.ourdata1, 
         method = "circle")

```

# perform univariate analysis
```{r}
mod.age <- lm(charges ~ age, data = ourdata1)
summary(mod.age)
tidy(mod.age, conf.int = TRUE)                                                     
```


```{r}
mod.smoker <- lm(charges ~ smoker, data = ourdata1)
summary(mod.smoker)
tidy(mod.smoker, conf.int = TRUE)
```
```{r}
mod.region <- lm(charges ~ region, data = ourdata1)
summary(mod.region)
tidy(mod.region, conf.int = TRUE)
```


```{r}
mod.bmi <- lm(charges ~ bmi, data = ourdata1)
summary(mod.bmi)
tidy(mod.bmi, conf.int = TRUE)
```


```{r}
mod.sex <- lm(charges ~ sex, data = ourdata1)
summary(mod.sex)
tidy(mod.sex, conf.int = TRUE)
```


```{r}
mod.children <- lm(charges ~ children, data = ourdata1)
summary(mod.children)
tidy(mod.children, conf.int = TRUE)
```

# then proceed with multivariate analysis
```{r}
mod.age.smoker.region <- lm(charges ~ age + smoker + region, data = ourdata1)
summary(mod.age.smoker.region)

```

# Model selection
```{r}
ourdata1.complete <- 
  ourdata1 %>% 
  dplyr::select(charges, age,smoker, region, bmi, children, sex) %>% 
         drop_na()
```

# backward selection
```{r}
multivar.m <- lm(charges ~ age + smoker + bmi + sex + region + children,
                 data = ourdata1)
step.bw <- MASS::stepAIC(multivar.m, direction="backward")
```


```{r}
cont.only.m <- lm(charges ~ 1, data = ourdata1.complete)
multivar.m.complete <- 
  lm(charges ~ age + smoker + bmi + sex + region + children, 
     data = ourdata1.complete)
```

# run both
```{r}
step.both <- MASS::stepAIC(cont.only.m, direction="both",
                     scope=list(upper = multivar.m.complete,
                                lower = cont.only.m))
```

# forward only
```{r}
step.fw <- MASS::stepAIC(cont.only.m, direction = "forward",
                    scope=list(upper = multivar.m.complete,
                                lower = cont.only.m))
```


```{r}
step.both$anova
```


```{r}
step.fw$anova 
```


```{r}
step.bw$anova
```

# after all, let start with our on model
```{r}
mod.age.smoker.region <- lm(charges ~ age + smoker + region, 
                          data = ourdata1)
summary(mod.age.smoker.region)
```

# lets identify interactions
```{r}
mod.age.region <- lm(charges ~ age + region, data = ourdata1)
tidy(mod.age.region)
```
# A model with covariates age and region and interaction between them
```{r}
int.age.region <-lm(charges ~ age + region + age:region, data = ourdata1)
summary(int.age.region)
```
```{r}
int.age.region <-lm(charges ~ age + region + age:region, data = ourdata1)
tidy(int.age.region)
```

# check between 2 models using anova
```{r}
anova(mod.age.region, int.age.region)
```

# Model assessment
```{r}
prelim.final.m <- lm(charges ~ age + smoker + region, data = ourdata1)
```

# Diagnostics plots
```{r}
plot(prelim.final.m)
```

# check QQ plot
```{r}
library(lmtest)
```


```{r}
bptest(prelim.final.m)
```


```{r}
shapiro.test(prelim.final.m$residuals)
```
# Plot residuals against
independent variables in the model
other variables not in the model

```{r}
augment(prelim.final.m) %>%
  ggplot(aes(x = age, y = .resid))+
  geom_point()+
  geom_smooth()
```


```{r}
MASS::boxcox(prelim.final.m)
```

# plot to check model assessment
```{r}
res.mod <- residuals(prelim.final.m)
head(res.mod)
```

# make histogram
```{r}
hist(res.mod)
```


```{r}
library(DT)
```


```{r}
ourdata1.pred.res <- augment(prelim.final.m)
ourdata1.pred.res %>% datatable()
```

# Predictions
```{r}
pred.charges <- augment(prelim.final.m, data = ourdata1)
```




